#!/bin/sh

set -e

git_dir=$(git rev-parse --git-dir)
lock="$git_dir/tags.lock"
file="$git_dir/tags.$$"

mkdir "$lock" 2>/dev/null || exit 0
trap 'rmdir "$lock"; rm -f "$file"' EXIT INT TERM

if [ -f Gemfile -o "${0##*/}" = "git-ripper-tags" ]; then
  ripper-tags -R --tag-relative -f"$file" --exclude=.git --exclude=log --exclude=vendor --exclude=.bundle
else
  git ls-files -oc --exclude-standard | ctags --tag-relative -L- -f"$file"
fi

mv "$file" "${file%.$$}"
